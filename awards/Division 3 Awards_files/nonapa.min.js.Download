var timer,myApaUrl,$j=jQuery.noConflict(),disableSessionExpiredPopup=!1,showPopup=!1,showSessionExpiredPopup=!1,expiredTime=30,reminderTime=25,cancelReminder=!1,minutesToRefresh=1,refreshRate=6e4*minutesToRefresh,minutesCounter=0,isHttpsPage="https:"==window.location.protocol,isLogedIn=!1,result=!1,elapsedTime=0,elapsedMinutesCounter=0;function updateLoginLink(){$j.ajax({url:window.location.protocol+"//"+window.location.host+"/idem/IsSessionValid",type:"POST",contentType:"application/json; charset-utf-8",data:JSON.stringify({sessionID:getCookie("ERIGHTS")}),async:!0}).done(function(e){(result="true"==e.toLowerCase())?($j("#HeaderLogoutLink").show(),$j("#HeaderMyApaLink").length&&$j("#HeaderMyApaLink").show(),$j("#HeaderLoginLink").hide(),isLogedIn=!0,0===$j("#HeaderCart").length&&$j("#HeaderLogoutLink").addClass("last-li")):($j("#HeaderLoginLink").show(),$j("#HeaderLogoutLink").hide(),$j("#HeaderMyApaLink").length&&$j("#HeaderMyApaLink").hide(),$j("#HeaderLogoutLink").hasClass("last-li")&&$j("#HeaderLogoutLink").removeClass("last-li"),isLogedIn=!1)}).fail(function(){result=!1})}function logout(){window.parent.location.href.includes("/secure/")?window.parent.location.href=$j("#HeaderLogoutLink a").attr("href").split("/secure")[0]:window.parent.location.href=$j("#HeaderLogoutLink a").attr("href")}function checkSessionStatus(){isLogedIn?(reminderTime<=minutesCounter&&!cancelReminder&&showReminder(),expiredTime<=minutesCounter&&(isSessionValid()||(cancelReminder=!0,showExpired()))):clearInterval(timer),minutesCounter+=minutesToRefresh}function showExpired(){$j("#HeaderLoginLink").show(),$j("#HeaderLogoutLink").hide(),$j("#HeaderMyApaLink").length&&$j("#HeaderMyApaLink").hide(),clearInterval(timer),isLogedIn=!1,window.location.pathname.startsWith("/secure")?window.location.href="/":showExpiredModal()}function showReminder(){showReminderModal()}function showExpiredModal(){$j(".ui-dialog-content.ui-widget-content").dialog("close"),$j("<div id='sessionExpiredOverlay'  title='Session Expired'><p>You have been logged out. Do you want to log in again?</p></div>").dialog({dialogClass:"session-reminder-wrapper",resizable:!1,height:"auto",width:400,modal:!0,buttons:{"Log in":function(){$j(this).dialog("close"),window.location=myApaUrl+"/apasso/idm/apalogin?ERIGHTS_TARGET="+encodeURIComponent(window.parent.location.href)},Close:function(){$j(this).dialog("close")}}})}function showReminderModal(){var e=expiredTime-minutesCounter,e=0<=e?e:"";minutesToRefresh=1,$j(".ui-dialog-content.ui-widget-content").dialog("close"),$j(`
	<div id="sessionReminderOverlay" title="Are you still there?">	
		<p>
			Your session is about to expire! You will be logged out in <b id=timeRemaining>${e}</b> minute(s). If you are logged out, you may lose unsaved information.
			<br/><br/>
			Do you want to stay logged in?
		</p>
	</div>`).dialog({dialogClass:"session-reminder-wrapper",resizable:!1,height:"auto",width:400,modal:!0,buttons:{"Keep me logged in":function(){$j(this).dialog("close"),refreshSession()},"Log out":function(){cancelReminder=!0,$j(this).dialog("close"),window.location.href=$j("#HeaderLogoutLink a").attr("href")}}})}function deleteErightsCookies(){document.cookie="ERIGHTS=; expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=.supportpsychologypac.org; Secure"}function getCookie(e){for(var o=e+"=",i=document.cookie.split(";"),n=0;n<i.length;n++){for(var t=i[n];" "==t.charAt(0);)t=t.substring(1,t.length);if(0==t.indexOf(o))return t.substring(o.length,t.length)}return null}function isSessionValid(){return result=!1,$j.ajax({url:window.location.protocol+"//"+window.location.host+"/idem/IsSessionValid",type:"POST",contentType:"application/json; charset-utf-8",data:JSON.stringify({sessionID:getCookie("ERIGHTS")}),async:!0,success:function(e){e&&(result="true"==e.toLowerCase())},error:function(e,o){result=!1}}),result}function refreshSession(){$j.ajax({url:window.location.protocol+"//"+window.location.host+"/idem/RefreshSession",type:"POST",contentType:"application/json; charset-utf-8",data:JSON.stringify({sessionID:getCookie("ERIGHTS")}),async:!1,success:function(e){1!=e&&"true"!=e.toLowerCase()||(minutesCounter=0)},error:function(e,o){}})}function loginToIdem(){window.parent.location.href.includes("/secure/")?window.parent.location.href=myApaUrl+"/apalogin?ERIGHTS_TARGET="+encodeURIComponent(window.parent.location.origin):window.parent.location.href=myApaUrl+"/apalogin?ERIGHTS_TARGET="+encodeURIComponent(window.parent.location.href)}$j(window).on("blur focus",function(e){if($j(this).data("prevType")!=e.type)switch(e.type){case"blur":isLogedIn&&(elapsedTime=Date.now(),elapsedMinutesCounter=minutesCounter),console.log("blure");break;case"focus":0<elapsedTime&&isLogedIn&&(duration=Math.floor((Date.now()-elapsedTime)/1e3/60),minutesCounter==elapsedMinutesCounter&&(minutesCounter+=duration),elapsedTime=elapsedMinutesCounter=0),console.log("focus")}$j(this).data("prevType",e.type)}),$j(document).ready(function(){var e;0!=$j("#HeaderLoginLink a").length&&(myApaUrl=(myApaUrl=$j("#HeaderLoginLink a").attr("href").split("/")[0]+"//"+$j("#HeaderLoginLink a").attr("href").split("/")[2]).replace("http:","https:"),updateLoginLink(),$j("#HeaderLogoutLink a").click(function(){return logout(),!1}),-1<(e=window.location.href.toLowerCase()).indexOf("login")||-1<e.indexOf("register")||(timer=setInterval(checkSessionStatus,refreshRate),minutesCounter+=minutesToRefresh))});